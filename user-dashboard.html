<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… | Future Site</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --brand-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --order-purple: #6c5ce7;
            --success: #27ae60;
            --danger: #ff4757;
            --bg-body: #f4f7f6;
        }
        body { font-family: 'Cairo', sans-serif; background: var(--bg-body); margin: 0; padding-bottom: 50px; text-align: right; }
        .container { max-width: 900px; margin: auto; padding: 15px; }
        .store-name-card { background: var(--brand-gradient); padding: 30px; border-radius: 25px; text-align: center; color: #fff; margin-bottom: 15px; position: relative; }
        .btn-main { width: 100%; padding: 16px; border: none; border-radius: 18px; font-weight: 900; cursor: pointer; margin-bottom: 15px; font-size: 1rem; font-family: 'Cairo'; }
        input, select, textarea { width: 100%; padding: 15px; margin-bottom: 12px; border-radius: 15px; border: 1px solid #ddd; font-family: 'Cairo'; box-sizing: border-box; }
        .upload-area { border: 2px dashed var(--order-purple); padding: 20px; border-radius: 20px; text-align: center; cursor: pointer; background: #f8f7ff; margin-bottom: 15px; }
        .product-item { background: white; padding: 15px; border-radius: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; border: 1px solid #eee; }
        .p-img { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 5000; padding: 20px; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; }
        .hidden { display: none; }
        .order-card { background: white; border-radius: 20px; padding: 15px; margin-bottom: 15px; border-right: 5px solid var(--order-purple); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container">
    <div class="store-name-card">
        <h1 id="displayStoreName">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h1>
    </div>

    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px;">
        <div style="background:white; padding:10px; border-radius:15px; text-align:center;"><span>Ø§Ù„ÙŠÙˆÙ…</span><strong id="daySales" style="display:block; color:var(--success)">0</strong></div>
        <div style="background:white; padding:10px; border-radius:15px; text-align:center;"><span>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</span><strong id="weekSales" style="display:block; color:var(--success)">0</strong></div>
        <div style="background:white; padding:10px; border-radius:15px; text-align:center;"><span>Ø§Ù„Ø´Ù‡Ø±</span><strong id="monthSales" style="display:block; color:var(--success)">0</strong></div>
    </div>

    <button class="btn-main" style="background:var(--order-purple); color:white;" onclick="toggleSection('ordersBox')">
        <i class="fas fa-shopping-cart"></i> Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
    </button>
    <div id="ordersBox" class="hidden"><div id="ordersList"></div></div>

    <button class="btn-main" style="background:var(--success); color:white;" onclick="toggleSection('productFormBox')">
        <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
    </button>
    
    <div id="productFormBox" class="hidden" style="background:white; padding:20px; border-radius:22px; margin-bottom:20px;">
        <input type="text" id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input type="number" id="pPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
        <textarea id="pDescription" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
        
        <label style="display:block; margin-bottom:10px; font-weight:bold;">
            <input type="checkbox" onchange="document.getElementById('pTimerDiv').classList.toggle('hidden')"> ØªÙØ¹ÙŠÙ„ Ø¹Ø¯Ø§Ø¯ ØªÙ†Ø§Ø²Ù„ÙŠ
        </label>
        <div id="pTimerDiv" class="hidden">
            <input type="datetime-local" id="pEndTime">
        </div>

        <div class="upload-area" onclick="document.getElementById('pFile').click()">
            <p id="fileLabel">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ ØµÙˆØ±Ø©</p>
            <input type="file" id="pFile" accept="image/*" class="hidden" onchange="processImg(this, 'add')">
        </div>
        <button class="btn-main" id="saveBtn" style="background:var(--order-purple); color:white;" onclick="handleAddProduct()">Ù†Ø´Ø± Ø§Ù„Ù…Ù†ØªØ¬</button>
    </div>

    <div style="background:white; padding:20px; border-radius:25px; border:1px solid #eee;">
        <h3>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</h3>
        <div id="productsList"></div>
    </div>
</div>

<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ âœ¨</h3>
        <input type="hidden" id="editKey">
        <input type="text" id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…">
        <input type="number" id="editPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
        <textarea id="editDesc" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
        
        <label style="display:block; margin-bottom:10px; font-weight:bold;">
            <input type="checkbox" id="editUseTimer" onchange="document.getElementById('editTimerDiv').classList.toggle('hidden')"> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯
        </label>
        <div id="editTimerDiv" class="hidden">
            <input type="datetime-local" id="editEndTime">
        </div>

        <div class="upload-area" onclick="document.getElementById('editFile').click()">
            <p id="editFileLabel">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</p>
            <input type="file" id="editFile" accept="image/*" class="hidden" onchange="processImg(this, 'edit')">
        </div>
        <button class="btn-main" id="updateBtn" style="background:var(--success); color:white;" onclick="handleUpdate()">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="btn-main" style="background:#eee;" onclick="document.getElementById('editModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDCdnCI1cKdR4wvU2Y_cnw9essx1MYgA2w",
        authDomain: "futuresite-74037.firebaseapp.com",
        databaseURL: "https://futuresite-74037-default-rtdb.firebaseio.com",
        projectId: "futuresite-74037",
        storageBucket: "futuresite-74037.firebasestorage.app",
        appId: "1:643691438622:web:78f958cb5ba52a6069c40f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const storage = getStorage(app);
    const storeId = localStorage.getItem('myStoreId');

    let addBlob = null, editBlob = null, currentEditImg = "";

    // Ø¶ØºØ· Ø§Ù„ØµÙˆØ±
    window.processImg = (input, mode) => {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let w = img.width, h = img.height;
                if(w>800) { h *= 800/w; w=800; }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);
                canvas.toBlob((b) => {
                    if(mode==='add'){ addBlob=b; document.getElementById('fileLabel').innerText="âœ… Ø¬Ø§Ù‡Ø²Ø©"; }
                    else { editBlob=b; document.getElementById('editFileLabel').innerText="âœ… ØµÙˆØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø¬Ø§Ù‡Ø²Ø©"; }
                }, 'image/jpeg', 0.7);
            };
        };
        reader.readAsDataURL(file);
    };

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    onValue(ref(db, `stores/${storeId}/products`), (snap) => {
        const list = document.getElementById('productsList');
        list.innerHTML = "";
        if(snap.exists()){
            Object.entries(snap.val()).forEach(([key, p]) => {
                list.innerHTML += `
                <div class="product-item">
                    <img src="${p.image}" class="p-img">
                    <div style="flex:1; margin:0 10px;"><strong>${p.name}</strong></div>
                    <div style="display:flex; gap:5px;">
                        <button onclick="openEdit('${key}', \`${p.name}\`, '${p.price}', \`${p.description||''}\`, '${p.image}', ${p.hasTimer}, '${p.endTime||''}')" style="border:none; background:#e3f2fd; color:#1976d2; padding:10px; border-radius:10px;"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteP('${key}')" style="border:none; background:#ffebee; color:red; padding:10px; border-radius:10px;"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            });
        }
    });

    // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    onValue(ref(db, `stores/${storeId}/orders`), (snap) => {
        const oList = document.getElementById('ordersList');
        oList.innerHTML = "";
        let d=0, w=0, m=0;
        if(snap.exists()){
            Object.entries(snap.val()).reverse().forEach(([key, o]) => {
                d += parseFloat(o.productPrice || 0);
                oList.innerHTML += `
                <div class="order-card">
                    <strong>Ø§Ù„Ø²Ø¨ÙˆÙ†: ${o.customerName}</strong><br>
                    <span>Ø§Ù„Ù‡Ø§ØªÙ: ${o.customerPhone}</span><br>
                    <span>Ø§Ù„Ù…Ù†ØªØ¬: ${o.productName}</span>
                </div>`;
            });
        }
        document.getElementById('daySales').innerText = d;
    });

    // Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬
    window.handleAddProduct = async () => {
        const name = document.getElementById('pName').value;
        const price = document.getElementById('pPrice').value;
        if(!name || !price || !addBlob) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±Ø©");
        
        const imgRef = sRef(storage, `products/${Date.now()}.jpg`);
        const snap = await uploadBytes(imgRef, addBlob);
        const url = await getDownloadURL(snap.ref);

        await push(ref(db, `stores/${storeId}/products`), {
            name, price, image: url,
            description: document.getElementById('pDescription').value,
            hasTimer: document.getElementById('pTimerDiv').classList.contains('hidden') ? false : true,
            endTime: document.getElementById('pEndTime').value
        });
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"); location.reload();
    };

    // ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    window.openEdit = (key, name, price, desc, img, hasTimer, endTime) => {
        document.getElementById('editKey').value = key;
        document.getElementById('editName').value = name;
        document.getElementById('editPrice').value = price;
        document.getElementById('editDesc').value = desc;
        document.getElementById('editUseTimer').checked = hasTimer;
        document.getElementById('editEndTime').value = endTime;
        if(hasTimer) document.getElementById('editTimerDiv').classList.remove('hidden');
        else document.getElementById('editTimerDiv').classList.add('hidden');
        currentEditImg = img; editBlob = null;
        document.getElementById('editModal').style.display = 'flex';
    };

    // Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    window.handleUpdate = async () => {
        const key = document.getElementById('editKey').value;
        let url = currentEditImg;
        if(editBlob){
            const imgRef = sRef(storage, `products/${Date.now()}.jpg`);
            const snap = await uploadBytes(imgRef, editBlob);
            url = await getDownloadURL(snap.ref);
        }
        await update(ref(db, `stores/${storeId}/products/${key}`), {
            name: document.getElementById('editName').value,
            price: document.getElementById('editPrice').value,
            description: document.getElementById('editDesc').value,
            hasTimer: document.getElementById('editUseTimer').checked,
            endTime: document.getElementById('editEndTime').value,
            image: url
        });
        alert("ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«"); document.getElementById('editModal').style.display='none';
    };

    window.deleteP = (id) => confirm("Ø­Ø°ÙØŸ") && remove(ref(db, `stores/${storeId}/products/${id}`));
    window.toggleSection = (id) => document.getElementById(id).classList.toggle('hidden');
    onValue(ref(db, `stores/${storeId}/name`), s => document.getElementById('displayStoreName').innerText = s.val());

</script>
</body>
</html>
